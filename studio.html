<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ineffable Design â€” Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f7f5f0;
  --white: #ffffff;
  --ink: #0d0d0d;
  --muted: #888580;
  --line: #e2ded6;
  --accent: #b8ff57;
  --accent2: #ff85c8;
  --accent3: #85c8ff;
  --r: 999px;
}

html, body { height: 100%; }

body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
  cursor: none;
}

/* â”€â”€ GLITTER CURSOR â”€â”€ */
.cursor-dot {
  position: fixed;
  width: 8px; height: 8px;
  background: var(--accent2);
  border-radius: 50%;
  pointer-events: none;
  z-index: 9999;
  transform: translate(-50%, -50%);
  mix-blend-mode: multiply;
}
.glitter-particle {
  position: fixed;
  pointer-events: none;
  z-index: 9998;
  transform: translate(-50%, -50%);
  animation: glitterFade var(--dur) ease forwards;
  font-size: var(--size);
  color: var(--color);
  filter: drop-shadow(0 0 3px var(--color));
}
@keyframes glitterFade {
  0% { opacity:1; transform:translate(-50%,-50%) scale(1) rotate(0deg); }
  100% { opacity:0; transform:translate(calc(-50% + var(--dx)),calc(-50% + var(--dy))) scale(0.1) rotate(var(--rot)); }
}

/* â”€â”€ NOISE â”€â”€ */
body::before {
  content:'';
  position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none; z-index:0; opacity:0.4;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 24px;
  border-bottom:1px solid var(--line);
  background:rgba(247,245,240,0.92);
  backdrop-filter:blur(12px);
  position:sticky; top:0; z-index:200;
}
.logo-wrap { display:flex; flex-direction:column; gap:1px; }
.logo { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:800; letter-spacing:-0.04em; color:var(--ink); text-transform:uppercase; }
.logo-sub { font-size:0.5rem; letter-spacing:0.18em; text-transform:uppercase; color:var(--muted); }
.header-pills { display:flex; gap:8px; align-items:center; }

.pill {
  font-family:'Space Mono',monospace; font-size:0.58rem; letter-spacing:0.04em;
  padding:7px 14px; border-radius:var(--r); cursor:pointer;
  border:1px solid var(--line); background:transparent; color:var(--muted);
  transition:all 0.18s; text-transform:uppercase;
}
.pill:hover { border-color:var(--ink); color:var(--ink); }
.pill-dark { background:var(--ink); color:var(--accent); border-color:var(--ink); }
.pill-dark:hover { background:#222; transform:translateY(-1px); }

/* â”€â”€ MARQUEE â”€â”€ */
.marquee-wrap {
  background:var(--ink); color:var(--accent);
  font-family:'Syne',sans-serif; font-size:0.62rem; font-weight:700;
  letter-spacing:0.12em; text-transform:uppercase;
  overflow:hidden; padding:6px 0; white-space:nowrap;
}
.marquee-inner { display:inline-block; animation:marquee 22s linear infinite; }
@keyframes marquee { from{transform:translateX(0)} to{transform:translateX(-50%)} }

/* â”€â”€ STUDIO LAYOUT â”€â”€ */
.studio {
  display:grid;
  grid-template-columns:240px 1fr 260px;
  height:calc(100vh - 76px);
  position:relative; z-index:1;
}

/* â”€â”€ PANELS â”€â”€ */
.panel {
  background:var(--white);
  border-right:1px solid var(--line);
  overflow-y:auto;
  padding:18px 14px;
  display:flex; flex-direction:column; gap:16px;
}
.panel-right { border-right:none; border-left:1px solid var(--line); }
.panel-label {
  font-family:'Syne',sans-serif; font-size:0.58rem; font-weight:700;
  letter-spacing:0.2em; text-transform:uppercase; color:var(--muted);
  padding-bottom:8px; border-bottom:1px solid var(--line);
}

/* â”€â”€ SHIRT STYLE PICKER â”€â”€ */
.style-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
.style-btn {
  font-family:'Space Mono',monospace; font-size:0.58rem;
  padding:8px 6px; border-radius:8px; cursor:pointer;
  border:1px solid var(--line); background:var(--bg);
  color:var(--muted); transition:all 0.15s; text-align:center;
  text-transform:uppercase; letter-spacing:0.04em;
}
.style-btn:hover { border-color:var(--ink); color:var(--ink); }
.style-btn.active { background:var(--ink); color:var(--accent); border-color:var(--ink); }

/* â”€â”€ COLOR SWATCHES â”€â”€ */
.color-row { display:flex; flex-wrap:wrap; gap:6px; }
.cswatch {
  width:28px; height:28px; border-radius:50%; cursor:pointer;
  border:2px solid transparent; transition:all 0.15s;
}
.cswatch:hover { transform:scale(1.12); }
.cswatch.active { border-color:var(--ink); box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--ink); }

/* â”€â”€ STICKER LIBRARY â”€â”€ */
.search-wrap { display:flex; gap:6px; }
.search-bar {
  flex:1; font-family:'Space Mono',monospace; font-size:0.68rem;
  padding:8px 12px; border:1px solid var(--line); border-radius:var(--r);
  background:var(--bg); color:var(--ink); outline:none; transition:border-color 0.15s;
}
.search-bar:focus { border-color:var(--ink); }
.search-bar::placeholder { color:var(--muted); }

.random-btn {
  font-size:1rem; padding:0 10px; border-radius:var(--r);
  border:1px solid var(--line); background:var(--bg);
  cursor:pointer; transition:all 0.15s;
}
.random-btn:hover { background:var(--accent); border-color:var(--accent); transform:rotate(20deg); }

.cat-label { font-size:0.56rem; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted); margin-top:2px; }

.sticker-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; }
.sticker-tile {
  aspect-ratio:1; background:var(--bg); border:1px solid var(--line);
  border-radius:8px; display:flex; align-items:center; justify-content:center;
  font-size:1.3rem; cursor:grab; transition:all 0.15s; user-select:none;
}
.sticker-tile:hover {
  background:var(--accent); border-color:var(--accent);
  transform:translateY(-2px) rotate(-4deg);
  box-shadow:0 6px 16px rgba(0,0,0,0.1); z-index:2;
}
.sticker-tile:active { cursor:grabbing; transform:scale(0.92); }

/* â”€â”€ CANVAS â”€â”€ */
.canvas-area {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:14px; background:var(--bg); padding:20px; position:relative;
}

.canvas-hint {
  font-size:0.58rem; letter-spacing:0.14em; text-transform:uppercase;
  color:var(--muted); background:var(--white); border:1px solid var(--line);
  border-radius:var(--r); padding:4px 12px;
}

/* ZOOM */
.zoom-bar { display:flex; gap:6px; align-items:center; }
.zoom-btn {
  width:28px; height:28px; border-radius:50%; border:1px solid var(--line);
  background:var(--white); font-size:1rem; cursor:pointer; display:flex;
  align-items:center; justify-content:center; transition:all 0.15s; color:var(--ink);
}
.zoom-btn:hover { border-color:var(--ink); background:var(--ink); color:var(--accent); }
.zoom-val { font-size:0.62rem; color:var(--muted); min-width:36px; text-align:center; }

.shirt-outer {
  overflow:hidden; border-radius:12px;
  width:300px; height:380px;
  display:flex; align-items:center; justify-content:center;
}

.shirt-wrap {
  position:relative;
  width:300px; height:380px;
  filter:drop-shadow(0 20px 40px rgba(0,0,0,0.10));
  transform-origin:center;
  transition:transform 0.15s;
}
.shirt-wrap.tilting { transition:transform 0.1s; }

.shirt-svg {
  width:100%; height:100%;
  position:absolute; top:0; left:0;
  pointer-events:none; z-index:1;
}

.drop-zone {
  position:absolute;
  top:78px; left:80px;
  width:140px; height:180px;
  z-index:2; overflow:visible;
}
.drop-border {
  position:absolute; inset:-4px;
  border:1.5px dashed rgba(180,170,160,0.3);
  border-radius:4px; pointer-events:none; transition:all 0.2s;
}
.drop-zone.over .drop-border { border-color:var(--accent); background:rgba(184,255,87,0.04); }

/* â”€â”€ PLACED STICKERS â”€â”€ */
.ps {
  position:absolute; cursor:move; user-select:none;
  font-size:2rem; line-height:1; transition:filter 0.15s;
}
.ps:hover { filter:drop-shadow(0 3px 10px rgba(0,0,0,0.2)); }
.ps.sel { outline:1.5px dashed var(--accent2); outline-offset:5px; border-radius:4px; }

@keyframes wiggleIn {
  0%   { transform:scale(0.3) rotate(-15deg); opacity:0; }
  50%  { transform:scale(1.15) rotate(6deg); opacity:1; }
  70%  { transform:scale(0.95) rotate(-3deg); }
  85%  { transform:scale(1.05) rotate(2deg); }
  100% { transform:scale(1) rotate(0deg); opacity:1; }
}
.ps.just-added { animation:wiggleIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards; }

@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-8px)}
  40%{transform:translateX(8px)}
  60%{transform:translateX(-6px)}
  80%{transform:translateX(6px)}
}
.shake { animation:shake 0.4s ease; }

.rh {
  position:absolute; bottom:-9px; right:-9px;
  width:18px; height:18px; background:var(--ink);
  border:2px solid var(--accent); border-radius:50%;
  cursor:se-resize; display:none;
}
.ps.sel .rh { display:block; }

/* â”€â”€ CANVAS BAR â”€â”€ */
.canvas-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center; }
.bar-btn {
  font-family:'Space Mono',monospace; font-size:0.58rem; letter-spacing:0.04em;
  text-transform:uppercase; padding:6px 12px; border-radius:var(--r);
  cursor:pointer; border:1px solid var(--line); background:var(--white);
  color:var(--muted); transition:all 0.15s;
}
.bar-btn:hover { border-color:var(--ink); color:var(--ink); }
.bar-btn.kill:hover { border-color:var(--accent2); color:var(--accent2); }
.bar-btn.undo { border-color:var(--accent3); color:var(--accent3); }

/* â”€â”€ RIGHT PANEL â”€â”€ */
.ctrl-group { display:flex; flex-direction:column; gap:8px; }
.ctrl-lbl { font-size:0.58rem; letter-spacing:0.14em; text-transform:uppercase; color:var(--muted); }

.slider-row { display:flex; align-items:center; gap:8px; }
input[type=range] {
  -webkit-appearance:none; flex:1; height:2px;
  background:var(--line); border-radius:2px; outline:none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
  background:var(--ink); cursor:pointer; border:3px solid var(--accent);
}
.sval { font-size:0.65rem; color:var(--muted); width:28px; text-align:right; }

/* SIZE SELECTOR */
.size-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; }
.size-opt {
  font-family:'Space Mono',monospace; font-size:0.62rem; padding:7px 4px;
  border-radius:6px; cursor:pointer; border:1px solid var(--line);
  background:var(--bg); color:var(--muted); text-align:center;
  transition:all 0.15s; text-transform:uppercase;
}
.size-opt:hover { border-color:var(--ink); color:var(--ink); }
.size-opt.active { background:var(--ink); color:var(--accent); border-color:var(--ink); }

/* LAYERS */
.layer-list { display:flex; flex-direction:column; gap:4px; }
.layer-row {
  display:flex; align-items:center; gap:6px;
  padding:6px 8px; background:var(--bg); border:1px solid var(--line);
  border-radius:7px; font-size:0.64rem; cursor:pointer; transition:all 0.13s;
}
.layer-row:hover { border-color:var(--accent2); }
.layer-row.active { background:#fff0f8; border-color:var(--accent2); }
.layer-emoji { font-size:0.95rem; }
.layer-nm { flex:1; color:var(--muted); font-size:0.58rem; }
.layer-x { color:var(--line); font-size:0.7rem; cursor:pointer; transition:color 0.13s; }
.layer-x:hover { color:var(--accent2); }
.no-layers { font-size:0.64rem; color:var(--muted); text-align:center; padding:14px; border:1px dashed var(--line); border-radius:8px; line-height:1.7; }

/* â”€â”€ SAVE MODAL â”€â”€ */
.modal-bg {
  position:fixed; inset:0; background:rgba(13,13,13,0.55);
  backdrop-filter:blur(6px); z-index:500;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity 0.2s;
}
.modal-bg.open { opacity:1; pointer-events:all; }
.modal {
  background:var(--white); border-radius:20px; padding:28px 26px;
  width:420px; max-width:92vw; max-height:90vh; overflow-y:auto;
  border:1px solid var(--line);
  transform:translateY(20px); transition:transform 0.25s;
}
.modal-bg.open .modal { transform:translateY(0); }
.modal-title { font-family:'Syne',sans-serif; font-size:1.3rem; font-weight:800; letter-spacing:-0.03em; margin-bottom:4px; }
.modal-sub { font-size:0.64rem; color:var(--muted); margin-bottom:20px; line-height:1.6; }
.modal-order { font-size:0.6rem; color:var(--accent2); letter-spacing:0.1em; margin-bottom:16px; font-weight:700; }
.modal-input {
  width:100%; font-family:'Space Mono',monospace; font-size:0.8rem;
  padding:11px 14px; border:1.5px solid var(--line); border-radius:10px;
  background:var(--bg); color:var(--ink); outline:none; margin-bottom:10px; transition:border-color 0.15s;
}
.modal-input:focus { border-color:var(--ink); }
.modal-input::placeholder { color:var(--muted); }
textarea.modal-input { resize:vertical; min-height:80px; font-size:0.75rem; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:4px; }
.modal-cancel { background:transparent; border:1px solid var(--line); color:var(--muted); }
.modal-save { background:var(--ink); color:var(--accent); border:1px solid var(--ink); }
.modal-note { font-size:0.58rem; color:var(--muted); margin-top:12px; padding:9px 11px; background:var(--bg); border-radius:7px; line-height:1.7; border-left:3px solid var(--accent); }

/* â”€â”€ CONFETTI â”€â”€ */
.confetti-piece {
  position:fixed; width:8px; height:8px; pointer-events:none; z-index:9999;
  border-radius:2px;
  animation:confettiFall var(--dur) ease forwards;
}
@keyframes confettiFall {
  0% { transform:translate(0,0) rotate(0deg); opacity:1; }
  100% { transform:translate(var(--dx),var(--dy)) rotate(var(--rot)); opacity:0; }
}

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:24px; left:50%;
  transform:translateX(-50%) translateY(16px);
  background:var(--ink); color:var(--accent);
  font-family:'Space Mono',monospace; font-size:0.65rem;
  letter-spacing:0.06em; padding:10px 20px; border-radius:var(--r);
  opacity:0; transition:all 0.3s; pointer-events:none; z-index:900;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* â”€â”€ MOBILE â”€â”€ */
@media (max-width: 768px) {
  body { cursor:auto; }
  .cursor-dot { display:none; }

  header { padding:12px 16px; }
  .logo { font-size:0.95rem; }
  .logo-sub { display:none; }
  .pill { padding:6px 10px; font-size:0.55rem; }

  .marquee-wrap { display:none; }

  .studio {
    display:flex; flex-direction:column;
    height:auto; min-height:calc(100vh - 56px);
  }

  /* sticker panel on top as horizontal scroll */
  .panel:first-child {
    border-right:none; border-bottom:1px solid var(--line);
    padding:12px; max-height:none; overflow-x:auto; overflow-y:hidden;
    flex-direction:row; flex-wrap:nowrap; align-items:flex-start; gap:10px;
  }
  .panel:first-child .panel-label { display:none; }
  .panel:first-child .color-row { flex-wrap:nowrap; }
  .panel:first-child .search-wrap { min-width:160px; }
  .panel:first-child #stickerLib { display:flex; flex-direction:row; gap:8px; align-items:flex-start; }
  .panel:first-child .cat-label { display:none; }
  .panel:first-child .sticker-grid { grid-template-columns:repeat(4,1fr); min-width:160px; }

  /* canvas */
  .canvas-area { padding:16px 10px; gap:10px; order:2; }
  .shirt-outer { width:240px; height:300px; }
  .shirt-wrap { width:240px; height:300px; }
  .drop-zone { top:62px; left:64px; width:112px; height:144px; }

  /* right panel below canvas */
  .panel-right {
    border-left:none; border-top:1px solid var(--line);
    order:3; max-height:none; padding:14px;
  }

  .size-grid { grid-template-columns:repeat(4,1fr); }
  .style-grid { grid-template-columns:repeat(4,1fr); }

  .canvas-bar { gap:4px; }
  .bar-btn { font-size:0.52rem; padding:5px 9px; }

  .zoom-bar { display:none; }
}

::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-thumb { background:var(--line); border-radius:4px; }
</style>
</head>
<body>

<div class="cursor-dot" id="cursorDot"></div>

<!-- MARQUEE -->
<div class="marquee-wrap">
  <span class="marquee-inner">
    âœ¦ ineffable design &nbsp;&nbsp; make it yours &nbsp;&nbsp; âœ¦ drag. drop. create. &nbsp;&nbsp; âœ¦ ineffable design &nbsp;&nbsp; make it yours &nbsp;&nbsp; âœ¦ drag. drop. create. &nbsp;&nbsp; âœ¦ ineffable design &nbsp;&nbsp; make it yours &nbsp;&nbsp; âœ¦ drag. drop. create. &nbsp;&nbsp;
  </span>
</div>

<!-- HEADER -->
<header>
  <div class="logo-wrap">
    <div class="logo">Ineffable Design</div>
    <div class="logo-sub">custom shirt studio</div>
  </div>
  <div class="header-pills">
    <a href="index.html" class="pill">â† back</a>
    <button class="pill" onclick="undoLast()">undo â†©</button>
    <button class="pill" onclick="clearAll()">clear âœ•</button>
    <button class="pill pill-dark" onclick="openSaveModal()">save design â†’</button>
  </div>
</header>

<!-- STUDIO -->
<div class="studio">

  <!-- LEFT PANEL -->
  <div class="panel">
    <div class="panel-label">Shirt Style</div>
    <div class="style-grid" id="styleGrid"></div>

    <div class="panel-label">Shirt Color</div>
    <div class="color-row" id="colorRow"></div>

    <div class="panel-label">Sticker Library</div>
    <div class="search-wrap">
      <input class="search-bar" type="text" placeholder="search..." oninput="filterStickers(this.value)">
      <button class="random-btn" onclick="addRandomSticker()" title="random sticker!">ğŸ²</button>
    </div>
    <div id="stickerLib"></div>
  </div>

  <!-- CANVAS -->
  <div class="canvas-area">
    <div class="canvas-hint">âœ¦ tap stickers to place Â· drag to move</div>

    <div class="zoom-bar">
      <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
      <span class="zoom-val" id="zoomVal">100%</span>
      <button class="zoom-btn" onclick="zoomIn()">+</button>
    </div>

    <div class="shirt-outer" id="shirtOuter">
      <div class="shirt-wrap" id="shirtWrap">
        <svg class="shirt-svg" id="shirtSvg" viewBox="0 0 300 380" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="sf"><feDropShadow dx="0" dy="8" stdDeviation="12" flood-color="#000" flood-opacity="0.10"/></filter>
          </defs>
          <!-- TSHIRT (default) -->
          <g id="shirtShape" filter="url(#sf)">
            <path id="shirtBody" d="M92,26 C88,26 70,20 52,40 L6,86 L48,118 L62,100 L62,340 L238,340 L238,100 L252,118 L294,86 L248,40 C230,20 212,26 208,26 C203,50 178,66 150,66 C122,66 97,50 92,26 Z" fill="#f0ece4" stroke="#ddd9cf" stroke-width="1.2"/>
            <path d="M92,26 C97,50 122,66 150,66 C178,66 203,50 208,26 C195,31 174,38 150,38 C126,38 105,31 92,26 Z" fill="rgba(0,0,0,0.04)"/>
          </g>
        </svg>

        <div class="drop-zone" id="dropZone"
          ondragover="onOver(event)" ondragleave="onLeave(event)" ondrop="onDrop(event)"
          onclick="deselect()">
          <div class="drop-border"></div>
        </div>
      </div>
    </div>

    <div class="canvas-bar">
      <button class="bar-btn" onclick="bringFwd()">â†‘ fwd</button>
      <button class="bar-btn" onclick="sendBk()">â†“ back</button>
      <button class="bar-btn kill" onclick="delSel()">delete âœ•</button>
      <button class="bar-btn undo" onclick="undoLast()">undo â†©</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel panel-right">
    <div class="panel-label">Controls</div>

    <div class="ctrl-group">
      <span class="ctrl-lbl">Sticker Size</span>
      <div class="slider-row">
        <input type="range" min="16" max="110" value="56" id="szSlider" oninput="setSz(this.value)">
        <span class="sval" id="szVal">56</span>
      </div>
    </div>

    <div class="ctrl-group">
      <span class="ctrl-lbl">Opacity</span>
      <div class="slider-row">
        <input type="range" min="10" max="100" value="100" id="opSlider" oninput="setOp(this.value)">
        <span class="sval" id="opVal">100</span>
      </div>
    </div>

    <div class="ctrl-group">
      <span class="ctrl-lbl">Rotation</span>
      <div class="slider-row">
        <input type="range" min="-180" max="180" value="0" id="rotSlider" oninput="setRot(this.value)">
        <span class="sval" id="rotVal">0Â°</span>
      </div>
    </div>

    <div class="panel-label">Shirt Size</div>
    <div class="size-grid" id="sizeGrid"></div>

    <div class="panel-label">Layers</div>
    <div class="layer-list" id="layerList">
      <div class="no-layers" id="emptyMsg">your stickers<br>will appear here âœ¦</div>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-bg" id="modalBg" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-title">Save your design âœ¦</div>
    <div class="modal-order" id="orderNumDisplay"></div>
    <div class="modal-sub">Name your design and drop your contact â€” we'll reach out with pricing and details!</div>
    <input class="modal-input" id="designName" type="text" placeholder="design name e.g. 'starcore fit'" maxlength="60">
    <input class="modal-input" id="customerName" type="text" placeholder="your name" maxlength="60">
    <input class="modal-input" id="customerContact" type="text" placeholder="instagram / whatsapp" maxlength="100">
    <textarea class="modal-input" id="customerNotes" placeholder="any notes? e.g. 'star on the back', 'make it bigger'..." maxlength="300"></textarea>
    <div class="modal-actions">
      <button class="pill modal-cancel" onclick="closeModal()">cancel</button>
      <button class="pill modal-save" onclick="submitDesign()">send order â†’</button>
    </div>
    <div class="modal-note">ğŸ’Œ your design is saved securely â€” only the shop owner can see it. no spam ever!</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STICKERS = {
  "âœ¦ nature":   [{e:"ğŸŒ¸"},{e:"ğŸŒ¿"},{e:"ğŸ„"},{e:"ğŸŒ™"},{e:"â­"},{e:"ğŸŒŠ"},{e:"ğŸª´"},{e:"ğŸŒº"},{e:"ğŸƒ"},{e:"ğŸŒ»"},{e:"ğŸª¸"},{e:"ğŸŒ¾"}],
  "âœ¦ cosmos":   [{e:"ğŸª"},{e:"ğŸŒŒ"},{e:"â˜„ï¸"},{e:"ğŸŒ "},{e:"ğŸ”­"},{e:"ğŸ’«"},{e:"âœ¨"},{e:"ğŸ›¸"},{e:"ğŸŒ™"},{e:"âš¡"},{e:"ğŸª©"},{e:"ğŸ”®"}],
  "âœ¦ y2k":      [{e:"ğŸ¦‹"},{e:"ğŸ«§"},{e:"ğŸ’¿"},{e:"ğŸ“Ÿ"},{e:"ğŸ€"},{e:"ğŸ«¦"},{e:"ğŸ‘¾"},{e:"ğŸ•¹ï¸"},{e:"ğŸ’œ"},{e:"ğŸª¬"},{e:"ğŸŒ€"},{e:"â›“ï¸"}],
  "âœ¦ art":      [{e:"ğŸ–‹ï¸"},{e:"ğŸ¨"},{e:"ğŸ“·"},{e:"ğŸª"},{e:"ğŸ­"},{e:"ğŸ©°"},{e:"ğŸ§µ"},{e:"ğŸª¡"},{e:"âœï¸"},{e:"ğŸ–¼ï¸"},{e:"ğŸ¬"},{e:"ğŸ§"}]
};

const COLORS = [
  {c:"#f0ece4",n:"Cream"},{c:"#1a1814",n:"Black"},{c:"#ffffff",n:"White"},
  {c:"#b8d4e8",n:"Baby Blue"},{c:"#d4bce8",n:"Lavender"},{c:"#b8e4c8",n:"Sage"},
  {c:"#e8b8c8",n:"Rose"},{c:"#e8dab8",n:"Sand"},{c:"#b8ff57",n:"Lime"},
  {c:"#ffd166",n:"Butter"},{c:"#c0c0c0",n:"Silver"},{c:"#8b5e3c",n:"Mocha"}
];

const SHIRT_STYLES = [
  { id:"tshirt",    label:"T-Shirt" },
  { id:"oversized", label:"Oversized" },
  { id:"longsleeve",label:"Longsleeve" },
  { id:"hoodie",    label:"Hoodie" }
];

const SHIRT_PATHS = {
  tshirt: {
    body: "M92,26 C88,26 70,20 52,40 L6,86 L48,118 L62,100 L62,340 L238,340 L238,100 L252,118 L294,86 L248,40 C230,20 212,26 208,26 C203,50 178,66 150,66 C122,66 97,50 92,26 Z",
    collar: "M92,26 C97,50 122,66 150,66 C178,66 203,50 208,26 C195,31 174,38 150,38 C126,38 105,31 92,26 Z",
    extra: ""
  },
  oversized: {
    body: "M86,26 C80,26 58,18 36,42 L4,92 L52,128 L68,106 L68,350 L232,350 L232,106 L248,128 L296,92 L264,42 C242,18 220,26 214,26 C208,52 182,70 150,70 C118,70 92,52 86,26 Z",
    collar: "M86,26 C92,52 118,70 150,70 C182,70 208,52 214,26 C200,32 178,40 150,40 C122,40 100,32 86,26 Z",
    extra: ""
  },
  longsleeve: {
    body: "M92,26 C88,26 70,20 52,40 L6,86 L28,140 L62,120 L62,340 L238,340 L238,120 L272,140 L294,86 L248,40 C230,20 212,26 208,26 C203,50 178,66 150,66 C122,66 97,50 92,26 Z",
    collar: "M92,26 C97,50 122,66 150,66 C178,66 203,50 208,26 C195,31 174,38 150,38 C126,38 105,31 92,26 Z",
    extra: `<line x1="28" y1="140" x2="6" y2="340" stroke="currentColor" stroke-width="1" opacity="0.15"/>
            <line x1="272" y1="140" x2="294" y2="340" stroke="currentColor" stroke-width="1" opacity="0.15"/>
            <path d="M6,86 L6,340 L28,340 L28,140 L6,86 Z" fill="rgba(0,0,0,0.04)"/>
            <path d="M294,86 L294,340 L272,340 L272,140 L294,86 Z" fill="rgba(0,0,0,0.04)"/>`
  },
  hoodie: {
    body: "M92,26 C88,26 70,20 52,40 L6,86 L48,118 L62,100 L62,340 L238,340 L238,100 L252,118 L294,86 L248,40 C230,20 212,26 208,26 C203,50 178,66 150,66 C122,66 97,50 92,26 Z",
    collar: "M92,26 C97,50 122,66 150,66 C178,66 203,50 208,26 C195,31 174,38 150,38 C126,38 105,31 92,26 Z",
    extra: `<rect x="120" y="66" width="60" height="28" rx="14" fill="rgba(0,0,0,0.07)"/>
            <rect x="118" y="320" width="64" height="20" rx="6" fill="rgba(0,0,0,0.06)"/>
            <line x1="150" y1="94" x2="150" y2="320" stroke="rgba(0,0,0,0.06)" stroke-width="1.5"/>`
  }
};

const SIZES = ["XS","S","M","L","XL","XXL"];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let placed = [];
let undoStack = [];
let selId = null;
let dragEmoji = null;
let isDraggingFromLib = false;
let idCnt = 0;
let currentShirtColor = "#f0ece4";
let currentStyle = "tshirt";
let currentSize = "M";
let zoomLevel = 1;
let SB_URL = localStorage.getItem('sb_url') || '';
let SB_KEY = localStorage.getItem('sb_key') || '';

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  renderStyles();
  renderColors();
  renderStickers(STICKERS);
  renderSizes();
}

function renderStyles() {
  const grid = document.getElementById('styleGrid');
  grid.innerHTML = '';
  SHIRT_STYLES.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'style-btn' + (s.id === currentStyle ? ' active' : '');
    btn.textContent = s.label;
    btn.onclick = () => switchStyle(s.id);
    grid.appendChild(btn);
  });
}

function switchStyle(id) {
  currentStyle = id;
  const paths = SHIRT_PATHS[id];
  document.getElementById('shirtBody').setAttribute('d', paths.body);
  document.querySelector('#shirtShape path:last-of-type')?.setAttribute('d', paths.collar);
  // remove old extra
  document.getElementById('shirtExtra')?.remove();
  if (paths.extra) {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.id = 'shirtExtra';
    g.innerHTML = paths.extra;
    document.getElementById('shirtShape').appendChild(g);
  }
  document.querySelectorAll('.style-btn').forEach((b,i) => {
    b.classList.toggle('active', SHIRT_STYLES[i].id === id);
  });
  toast('âœ¦ style changed to ' + SHIRT_STYLES.find(s=>s.id===id).label.toLowerCase());
}

function renderColors() {
  const row = document.getElementById('colorRow');
  row.innerHTML = '';
  COLORS.forEach((c, i) => {
    const el = document.createElement('div');
    el.className = 'cswatch' + (i === 0 ? ' active' : '');
    el.style.background = c.c;
    el.style.border = c.c === '#ffffff' ? '2px solid #e0e0e0' : '2px solid transparent';
    el.title = c.n;
    el.onclick = () => {
      document.querySelectorAll('.cswatch').forEach(s => s.classList.remove('active'));
      el.classList.add('active');
      currentShirtColor = c.c;
      document.getElementById('shirtBody').setAttribute('fill', c.c);
    };
    row.appendChild(el);
  });
}

function renderSizes() {
  const grid = document.getElementById('sizeGrid');
  grid.innerHTML = '';
  SIZES.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'size-opt' + (s === currentSize ? ' active' : '');
    btn.textContent = s;
    btn.onclick = () => {
      currentSize = s;
      document.querySelectorAll('.size-opt').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
    grid.appendChild(btn);
  });
}

function renderStickers(data) {
  const lib = document.getElementById('stickerLib');
  lib.innerHTML = '';
  for (const [cat, items] of Object.entries(data)) {
    const cl = document.createElement('div');
    cl.className = 'cat-label';
    cl.textContent = cat;
    lib.appendChild(cl);
    const grid = document.createElement('div');
    grid.className = 'sticker-grid';
    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'sticker-tile';
      el.textContent = item.e;
      el.draggable = true;

      // FIX: separate drag and click properly
      el.addEventListener('dragstart', e => {
        isDraggingFromLib = true;
        dragEmoji = item.e;
        // hide ghost image
        const ghost = document.createElement('div');
        ghost.style.cssText = 'position:fixed;top:-999px;font-size:2rem;';
        ghost.textContent = item.e;
        document.body.appendChild(ghost);
        e.dataTransfer.setDragImage(ghost, 16, 16);
        setTimeout(() => ghost.remove(), 0);
        e.dataTransfer.effectAllowed = 'copy';
      });
      el.addEventListener('dragend', () => { isDraggingFromLib = false; });

      // click adds sticker without triggering drag
      el.addEventListener('click', () => { if (!isDraggingFromLib) addSticker(item.e); });

      // touch support
      el.addEventListener('touchstart', () => { dragEmoji = item.e; }, { passive: true });
      el.addEventListener('touchend', e => {
        const touch = e.changedTouches[0];
        const zone = document.getElementById('dropZone');
        const rect = zone.getBoundingClientRect();
        if (
          touch.clientX >= rect.left && touch.clientX <= rect.right &&
          touch.clientY >= rect.top && touch.clientY <= rect.bottom
        ) {
          const x = touch.clientX - rect.left - 18;
          const y = touch.clientY - rect.top - 18;
          addSticker(dragEmoji, x, y);
        } else {
          // just tap = add to center
          addSticker(item.e);
        }
        dragEmoji = null;
      }, { passive: true });

      grid.appendChild(el);
    });
    lib.appendChild(grid);
  }
}

function filterStickers(q) {
  if (!q.trim()) { renderStickers(STICKERS); return; }
  const lq = q.toLowerCase();
  const out = {};
  for (const [cat, items] of Object.entries(STICKERS)) {
    const m = items.filter(i => i.e.includes(lq) || cat.includes(lq));
    if (m.length) out[cat] = m;
  }
  if (!Object.keys(out).length) {
    document.getElementById('stickerLib').innerHTML = '<div class="no-layers" style="margin-top:6px">nothing found âœ•</div>';
  } else renderStickers(out);
}

function addRandomSticker() {
  const all = Object.values(STICKERS).flat();
  const item = all[Math.floor(Math.random() * all.length)];
  addSticker(item.e);
}

// â”€â”€ DRAG & DROP (desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onOver(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
function onLeave(e) { e.currentTarget.classList.remove('over'); }
function onDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('over');
  if (!dragEmoji) return;
  const rect = document.getElementById('dropZone').getBoundingClientRect();
  const x = e.clientX - rect.left - 18;
  const y = e.clientY - rect.top - 18;
  addSticker(dragEmoji, x, y);
  dragEmoji = null;
  isDraggingFromLib = false;
}

// â”€â”€ ADD STICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSticker(emoji, x, y) {
  const zone = document.getElementById('dropZone');
  const id = ++idCnt;
  const cx = x !== undefined ? Math.max(0, x) : 30 + Math.random() * 70;
  const cy = y !== undefined ? Math.max(0, y) : 40 + Math.random() * 80;

  const el = document.createElement('div');
  el.className = 'ps just-added';
  el.id = 'ps' + id;
  el.textContent = emoji;
  el.style.left = cx + 'px';
  el.style.top  = cy + 'px';
  el.style.fontSize = '2rem';

  setTimeout(() => el.classList.remove('just-added'), 500);

  const rh = document.createElement('div');
  rh.className = 'rh';
  el.appendChild(rh);

  makeDragMouse(el);
  makeDragTouch(el);
  makeResizeMouse(rh, el, id);
  makeResizeTouch(rh, el, id);

  // single click = select
  el.addEventListener('click', e => { e.stopPropagation(); select(id); });

  // double click = delete
  el.addEventListener('dblclick', e => {
    e.stopPropagation();
    saveUndo();
    const i = placed.findIndex(p => p.id === id);
    if (i >= 0) { placed[i].el.remove(); placed.splice(i,1); selId=null; updateLayers(); }
    toast('sticker deleted âœ•');
  });

  // tilt shirt on drag
  el.addEventListener('mousedown', () => tiltShirt());

  zone.appendChild(el);
  const stickerObj = { id, emoji, el, size:32, opacity:100, rot:0 };
  placed.push(stickerObj);
  select(id);
  updateLayers();
}

// â”€â”€ SHIRT TILT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tiltShirt() {
  const wrap = document.getElementById('shirtWrap');
  wrap.style.transform = `rotate(${(Math.random()-0.5)*3}deg) scale(1.01)`;
  document.addEventListener('mouseup', () => {
    wrap.style.transform = '';
  }, { once: true });
}

// â”€â”€ MOUSE DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeDragMouse(el) {
  let ox, oy, ex, ey, moved = false;
  el.addEventListener('mousedown', e => {
    if (e.target.classList.contains('rh')) return;
    e.preventDefault(); moved = false;
    ox = e.clientX; oy = e.clientY;
    ex = parseFloat(el.style.left); ey = parseFloat(el.style.top);
    const mv = e2 => {
      moved = true;
      el.style.left = (ex + e2.clientX - ox) + 'px';
      el.style.top  = (ey + e2.clientY - oy) + 'px';
    };
    const up = () => {
      document.removeEventListener('mousemove', mv);
      document.removeEventListener('mouseup', up);
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', up);
  });
}

// â”€â”€ TOUCH DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeDragTouch(el) {
  el.addEventListener('touchstart', e => {
    if (e.target.classList.contains('rh')) return;
    e.stopPropagation();
    const touch = e.touches[0];
    const ox = touch.clientX, oy = touch.clientY;
    const ex = parseFloat(el.style.left), ey = parseFloat(el.style.top);
    const mv = e2 => {
      e2.preventDefault();
      const t = e2.touches[0];
      el.style.left = (ex + t.clientX - ox) + 'px';
      el.style.top  = (ey + t.clientY - oy) + 'px';
    };
    const up = () => {
      document.removeEventListener('touchmove', mv);
      document.removeEventListener('touchend', up);
    };
    document.addEventListener('touchmove', mv, { passive:false });
    document.addEventListener('touchend', up);
  }, { passive:true });
}

// â”€â”€ MOUSE RESIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeResizeMouse(handle, el, id) {
  handle.addEventListener('mousedown', e => {
    e.stopPropagation(); e.preventDefault();
    const sx = e.clientX, ss = parseFloat(el.style.fontSize);
    const mv = e2 => {
      const nz = Math.max(14, Math.min(100, ss + (e2.clientX - sx) * 0.5));
      el.style.fontSize = nz + 'px';
      const s = placed.find(p => p.id === id);
      if (s) { s.size = nz; document.getElementById('szSlider').value = nz; document.getElementById('szVal').textContent = Math.round(nz); }
    };
    const up = () => { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', up);
  });
}

// â”€â”€ TOUCH RESIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeResizeTouch(handle, el, id) {
  handle.addEventListener('touchstart', e => {
    e.stopPropagation(); e.preventDefault();
    const sx = e.touches[0].clientX, ss = parseFloat(el.style.fontSize);
    const mv = e2 => {
      const nz = Math.max(14, Math.min(100, ss + (e2.touches[0].clientX - sx) * 0.5));
      el.style.fontSize = nz + 'px';
      const s = placed.find(p => p.id === id);
      if (s) { s.size = nz; document.getElementById('szSlider').value = nz; document.getElementById('szVal').textContent = Math.round(nz); }
    };
    const up = () => { document.removeEventListener('touchmove', mv); document.removeEventListener('touchend', up); };
    document.addEventListener('touchmove', mv, { passive:false });
    document.addEventListener('touchend', up);
  }, { passive:false });
}

// â”€â”€ SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function select(id) {
  deselect(false);
  selId = id;
  const s = placed.find(p => p.id === id);
  if (!s) return;
  s.el.classList.add('sel');
  document.getElementById('szSlider').value = s.size;
  document.getElementById('szVal').textContent = Math.round(s.size);
  document.getElementById('opSlider').value = s.opacity;
  document.getElementById('opVal').textContent = s.opacity;
  document.getElementById('rotSlider').value = s.rot;
  document.getElementById('rotVal').textContent = s.rot + 'Â°';
  updateLayers();
}

function deselect(upd=true) {
  document.querySelectorAll('.ps').forEach(e => e.classList.remove('sel'));
  selId = null;
  if (upd) updateLayers();
}

// â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSel() { return placed.find(p => p.id === selId); }

function setSz(v) {
  document.getElementById('szVal').textContent = v;
  const s = getSel(); if (!s) return;
  s.size = +v; s.el.style.fontSize = v + 'px';
}
function setOp(v) {
  document.getElementById('opVal').textContent = v;
  const s = getSel(); if (!s) return;
  s.opacity = +v; s.el.style.opacity = v/100;
}
function setRot(v) {
  document.getElementById('rotVal').textContent = v + 'Â°';
  const s = getSel(); if (!s) return;
  s.rot = +v; s.el.style.transform = `rotate(${v}deg)`;
}

function delSel() {
  if (!selId) return;
  saveUndo();
  const i = placed.findIndex(p => p.id === selId);
  if (i < 0) return;
  placed[i].el.remove(); placed.splice(i,1); selId = null;
  updateLayers();
}

// FIX: z-index forward/back
function bringFwd() {
  const s = getSel(); if (!s) return;
  const idx = placed.findIndex(p => p.id === selId);
  if (idx < placed.length - 1) {
    const next = placed[idx + 1];
    placed[idx] = next; placed[idx+1] = s;
    s.el.parentNode.appendChild(s.el);
    toast('â†‘ brought forward');
  }
}
function sendBk() {
  const s = getSel(); if (!s) return;
  const idx = placed.findIndex(p => p.id === selId);
  if (idx > 0) {
    const prev = placed[idx - 1];
    placed[idx] = prev; placed[idx-1] = s;
    s.el.parentNode.insertBefore(s.el, s.el.parentNode.firstChild);
    toast('â†“ sent back');
  }
}

function clearAll() {
  saveUndo();
  placed.forEach(s => s.el.remove());
  placed = []; selId = null;
  updateLayers();
  toast('canvas cleared âœ¦');
}

// â”€â”€ UNDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveUndo() {
  undoStack.push(placed.map(s => ({
    id: s.id, emoji: s.emoji, size: s.size, opacity: s.opacity, rot: s.rot,
    left: s.el.style.left, top: s.el.style.top, zIndex: s.el.style.zIndex
  })));
  if (undoStack.length > 20) undoStack.shift();
}

function undoLast() {
  if (!undoStack.length) { toast('nothing to undo âœ¦'); return; }
  placed.forEach(s => s.el.remove());
  placed = [];
  selId = null;
  const prev = undoStack.pop();
  const zone = document.getElementById('dropZone');
  prev.forEach(p => {
    const el = document.createElement('div');
    el.className = 'ps';
    el.id = 'ps' + p.id;
    el.textContent = p.emoji;
    el.style.left = p.left;
    el.style.top = p.top;
    el.style.fontSize = p.size + 'px';
    el.style.opacity = p.opacity / 100;
    el.style.transform = `rotate(${p.rot}deg)`;
    el.style.zIndex = p.zIndex;
    const rh = document.createElement('div');
    rh.className = 'rh';
    el.appendChild(rh);
    makeDragMouse(el);
    makeDragTouch(el);
    makeResizeMouse(rh, el, p.id);
    makeResizeTouch(rh, el, p.id);
    el.addEventListener('click', e => { e.stopPropagation(); select(p.id); });
    el.addEventListener('dblclick', e => { e.stopPropagation(); saveUndo(); const i=placed.findIndex(x=>x.id===p.id); if(i>=0){placed[i].el.remove();placed.splice(i,1);selId=null;updateLayers();} });
    el.addEventListener('mousedown', () => tiltShirt());
    zone.appendChild(el);
    placed.push({ id:p.id, emoji:p.emoji, el, size:p.size, opacity:p.opacity, rot:p.rot });
  });
  updateLayers();
  toast('â†© undone!');
}

// â”€â”€ ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function zoomIn() {
  zoomLevel = Math.min(2, zoomLevel + 0.1);
  applyZoom();
}
function zoomOut() {
  zoomLevel = Math.max(0.5, zoomLevel - 0.1);
  applyZoom();
}
function applyZoom() {
  document.getElementById('shirtWrap').style.transform = `scale(${zoomLevel})`;
  document.getElementById('zoomVal').textContent = Math.round(zoomLevel * 100) + '%';
}

// â”€â”€ LAYERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLayers() {
  const list = document.getElementById('layerList');
  const empty = document.getElementById('emptyMsg');
  list.innerHTML = '';
  if (!placed.length) { list.appendChild(empty); return; }
  [...placed].reverse().forEach(s => {
    const row = document.createElement('div');
    row.className = 'layer-row' + (s.id === selId ? ' active' : '');
    row.innerHTML = `<span class="layer-emoji">${s.emoji}</span><span class="layer-nm">#${s.id}</span><span class="layer-x" onclick="event.stopPropagation();saveUndo();rmLayer(${s.id})">âœ•</span>`;
    row.onclick = () => select(s.id);
    list.appendChild(row);
  });
}

function rmLayer(id) {
  const i = placed.findIndex(p => p.id === id);
  if (i < 0) return;
  placed[i].el.remove(); placed.splice(i,1);
  if (selId === id) selId = null;
  updateLayers();
}

// â”€â”€ ORDER NUMBER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateOrderNum() {
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `IND-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${Math.floor(Math.random()*9000+1000)}`;
}

// â”€â”€ SAVE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentOrderNum = '';
function openSaveModal() {
  if (!placed.length) {
    const btn = document.querySelector('.pill-dark');
    btn.classList.add('shake');
    setTimeout(() => btn.classList.remove('shake'), 500);
    toast('add some stickers first! âœ¦');
    return;
  }
  currentOrderNum = generateOrderNum();
  document.getElementById('orderNumDisplay').textContent = 'âœ¦ order ref: ' + currentOrderNum;
  document.getElementById('modalBg').classList.add('open');
}
function closeModal() { document.getElementById('modalBg').classList.remove('open'); }
function closeModalOutside(e) { if (e.target === document.getElementById('modalBg')) closeModal(); }

async function submitDesign() {
  const name    = document.getElementById('designName').value.trim();
  const cname   = document.getElementById('customerName').value.trim();
  const contact = document.getElementById('customerContact').value.trim();
  const notes   = document.getElementById('customerNotes').value.trim();

  if (!name) { toast('please name your design âœ¦'); return; }

  const designData = {
    name,
    order_number: currentOrderNum,
    customer_name: cname || 'anonymous',
    contact: contact || 'none provided',
    notes: notes || '',
    shirt_style: currentStyle,
    shirt_color: currentShirtColor,
    shirt_size: currentSize,
    stickers: placed.map(s => ({
      emoji: s.emoji,
      left: s.el.style.left, top: s.el.style.top,
      size: s.size, opacity: s.opacity, rotation: s.rot,
      zIndex: s.el.style.zIndex || 1
    })),
    created_at: new Date().toISOString()
  };

  if (SB_URL && SB_KEY) {
    try {
      const res = await fetch(`${SB_URL}/rest/v1/designs`, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Prefer':'return=minimal'
        },
        body: JSON.stringify(designData)
      });
      if (res.ok) {
        closeModal();
        launchConfetti();
        toast('ğŸ‰ design sent! we\'ll contact you soon ğŸ’Œ');
      } else {
        toast('error saving â€” check supabase');
        console.error(await res.text());
      }
    } catch(e) {
      toast('connection error âœ•');
      console.error(e);
    }
  } else {
    const blob = new Blob([JSON.stringify(designData,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (name||'design') + '.json';
    a.click();
    closeModal();
    launchConfetti();
    toast('ğŸ‰ design saved!');
  }
}

// â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti() {
  const colors = ['#ff85c8','#b8ff57','#85c8ff','#ffd166','#ffffff','#ff85c8'];
  for (let i = 0; i < 80; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.setProperty('--dur', (0.8 + Math.random() * 1) + 's');
      el.style.setProperty('--dx', (Math.random()-0.5)*400 + 'px');
      el.style.setProperty('--dy', (100 + Math.random() * 400) + 'px');
      el.style.setProperty('--rot', (Math.random()*720-360) + 'deg');
      el.style.background = colors[Math.floor(Math.random()*colors.length)];
      el.style.left = (20 + Math.random()*60) + 'vw';
      el.style.top = '30vh';
      el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      el.style.width = (4 + Math.random()*8) + 'px';
      el.style.height = (4 + Math.random()*8) + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }, i * 18);
  }
}

// â”€â”€ GLITTER CURSOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cursorDot = document.getElementById('cursorDot');
const GLITTERS = ['âœ¦','âœ§','â‹†','â˜…','Â·','âœ¿','â‹'];
const GCOLORS  = ['#ff85c8','#b8ff57','#85c8ff','#ffd166','#ffffff'];
let lastGX = 0, lastGY = 0;

document.addEventListener('mousemove', e => {
  cursorDot.style.left = e.clientX + 'px';
  cursorDot.style.top  = e.clientY + 'px';
  const dist = Math.hypot(e.clientX - lastGX, e.clientY - lastGY);
  const count = Math.min(Math.floor(dist/8), 4);
  for (let i = 0; i < count; i++) {
    spawnGlitter(
      lastGX + (e.clientX-lastGX)*(i/Math.max(count,1)),
      lastGY + (e.clientY-lastGY)*(i/Math.max(count,1))
    );
  }
  lastGX = e.clientX; lastGY = e.clientY;
});

function spawnGlitter(x,y) {
  const el = document.createElement('div');
  el.className = 'glitter-particle';
  const color = GCOLORS[Math.floor(Math.random()*GCOLORS.length)];
  const dur = (0.35 + Math.random()*0.45)+'s';
  el.style.setProperty('--color', color);
  el.style.setProperty('--size', (0.5+Math.random()*0.85)+'rem');
  el.style.setProperty('--dur', dur);
  el.style.setProperty('--dx', (Math.random()-0.5)*34+'px');
  el.style.setProperty('--dy', (Math.random()*26+6)+'px');
  el.style.setProperty('--rot', (Math.random()*360)+'deg');
  el.style.left = x+'px'; el.style.top = y+'px';
  el.textContent = GLITTERS[Math.floor(Math.random()*GLITTERS.length)];
  document.body.appendChild(el);
  setTimeout(() => el.remove(), parseFloat(dur)*1000);
}

// also update supabase if saved
// update admin page to include shirt_style, shirt_size, notes fields
// (admin.html will auto-show new fields from jsonb)

init();
</script>
</body>
</html>
