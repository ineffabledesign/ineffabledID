<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ineffable Design — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f7f5f0;
  --white: #ffffff;
  --ink: #0d0d0d;
  --muted: #888580;
  --line: #e2ded6;
  --accent: #b8ff57;
  --accent2: #ff85c8;
  --r: 999px;
}

body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
}

/* LOGIN SCREEN */
.login-screen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 32px;
}

.login-box {
  background: var(--white);
  border: 1px solid var(--line);
  border-radius: 20px;
  padding: 40px 36px;
  width: 400px;
  max-width: 90vw;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.login-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.3rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  margin-bottom: 4px;
}
.login-sub { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.06em; margin-bottom: 8px; }

.inp {
  width: 100%;
  font-family: 'Space Mono', monospace;
  font-size: 0.78rem;
  padding: 12px 16px;
  border: 1.5px solid var(--line);
  border-radius: 10px;
  background: var(--bg);
  color: var(--ink);
  outline: none;
  transition: border-color 0.15s;
}
.inp:focus { border-color: var(--ink); }
.inp::placeholder { color: var(--muted); }

.btn {
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  padding: 12px 20px;
  border-radius: var(--r);
  cursor: pointer;
  border: none;
  transition: all 0.18s;
}
.btn-dark { background: var(--ink); color: var(--accent); }
.btn-dark:hover { background: #222; transform: translateY(-1px); }
.btn-ghost { background: transparent; border: 1px solid var(--line); color: var(--muted); }
.btn-ghost:hover { border-color: var(--ink); color: var(--ink); }

.err-msg { font-size: 0.65rem; color: #ff4444; display: none; }

/* MAIN ADMIN */
.admin-screen { display: none; min-height: 100vh; }

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 36px;
  border-bottom: 1px solid var(--line);
  background: rgba(247,245,240,0.9);
  backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-family: 'Syne', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: -0.04em;
  text-transform: uppercase;
}
.logo span { color: var(--accent2); }

.header-right { display: flex; gap: 10px; align-items: center; }

.stat-pill {
  font-size: 0.62rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 6px 14px;
  border-radius: var(--r);
  background: var(--ink);
  color: var(--accent);
  border: none;
}

/* ORDERS GRID */
.orders-wrap {
  padding: 32px 36px;
}

.orders-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.orders-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: -0.03em;
}

.refresh-btn {
  font-family: 'Space Mono', monospace;
  font-size: 0.62rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 8px 18px;
  border-radius: var(--r);
  border: 1px solid var(--line);
  background: var(--white);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
}
.refresh-btn:hover { border-color: var(--ink); color: var(--ink); }

.orders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

/* ORDER CARD */
.order-card {
  background: var(--white);
  border: 1px solid var(--line);
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.2s;
  cursor: pointer;
}
.order-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.09);
  border-color: var(--accent2);
}

.card-preview {
  height: 220px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  border-bottom: 1px solid var(--line);
  overflow: hidden;
}

/* Mini shirt preview */
.mini-shirt-wrap {
  position: relative;
  width: 160px;
  height: 200px;
}
.mini-shirt-svg {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0; left: 0;
  pointer-events: none;
}
.mini-drop-zone {
  position: absolute;
  top: 41px;
  left: 42px;
  width: 76px;
  height: 95px;
  pointer-events: none;
}
.mini-sticker {
  position: absolute;
  pointer-events: none;
  line-height: 1;
}

.card-info {
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.card-name {
  font-family: 'Syne', sans-serif;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.card-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.meta-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.62rem;
  color: var(--muted);
}
.meta-label {
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--line);
  width: 52px;
  flex-shrink: 0;
}
.meta-val { color: var(--ink); font-size: 0.68rem; }

.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 18px;
  border-top: 1px solid var(--line);
  background: var(--bg);
}

.card-date { font-size: 0.58rem; color: var(--muted); letter-spacing: 0.06em; }

.card-badge {
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: var(--r);
  background: var(--accent);
  color: var(--ink);
  font-weight: 700;
}

/* FULL PREVIEW MODAL */
.preview-modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(13,13,13,0.65);
  backdrop-filter: blur(8px);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}
.preview-modal-bg.open { opacity: 1; pointer-events: all; }

.preview-modal {
  background: var(--white);
  border-radius: 20px;
  padding: 32px;
  width: 680px;
  max-width: 94vw;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid var(--line);
  transform: translateY(24px);
  transition: transform 0.25s;
  display: flex;
  gap: 32px;
}
.preview-modal-bg.open .preview-modal { transform: translateY(0); }

.modal-left { flex-shrink: 0; }

.big-shirt-wrap {
  position: relative;
  width: 260px;
  height: 320px;
  filter: drop-shadow(0 16px 40px rgba(0,0,0,0.12));
}
.big-shirt-svg {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0; left: 0;
  pointer-events: none;
}
.big-drop-zone {
  position: absolute;
  top: 67px;
  left: 69px;
  width: 122px;
  height: 154px;
  pointer-events: none;
}
.big-sticker {
  position: absolute;
  pointer-events: none;
  line-height: 1;
}

.modal-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.modal-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.5rem;
  font-weight: 800;
  letter-spacing: -0.03em;
}

.detail-group { display: flex; flex-direction: column; gap: 8px; }
.detail-label {
  font-size: 0.58rem;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--muted);
  padding-bottom: 4px;
  border-bottom: 1px solid var(--line);
}
.detail-val { font-size: 0.78rem; color: var(--ink); }

.color-preview {
  width: 24px; height: 24px;
  border-radius: 50%;
  border: 1px solid var(--line);
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}

.sticker-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.sticker-chip {
  background: var(--bg);
  border: 1px solid var(--line);
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 1rem;
}

.modal-close {
  align-self: flex-start;
  margin-top: auto;
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
  font-size: 0.75rem;
  line-height: 2;
  grid-column: 1 / -1;
}

.loading {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
  font-size: 0.72rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  grid-column: 1 / -1;
}

/* TOAST */
.toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--ink);
  color: var(--accent);
  font-family: 'Space Mono', monospace;
  font-size: 0.68rem;
  letter-spacing: 0.06em;
  padding: 12px 22px;
  border-radius: var(--r);
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  z-index: 900;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--line); border-radius: 4px; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-title">Ineffable Design <span style="color:var(--accent2)">✦</span></div>
    <div class="login-sub">OWNER ADMIN — ENTER YOUR SUPABASE DETAILS</div>

    <input class="inp" id="loginUrl" type="text" placeholder="supabase project URL" value="">
    <input class="inp" id="loginKey" type="text" placeholder="publishable / anon key" value="">
    <input class="inp" id="loginPass" type="password" placeholder="admin password (set your own)">

    <button class="btn btn-dark" onclick="doLogin()">enter admin →</button>
    <div class="err-msg" id="errMsg">incorrect password or missing keys ✕</div>
  </div>
  <div style="font-size:0.6rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;">only you can see this page ✦</div>
</div>

<!-- ADMIN SCREEN -->
<div class="admin-screen" id="adminScreen">
  <header>
    <div class="logo">Ineffable <span>Admin</span></div>
    <div class="header-right">
      <div class="stat-pill" id="orderCount">0 designs</div>
      <button class="btn btn-ghost" onclick="logout()" style="font-size:0.62rem;padding:7px 14px;">logout</button>
    </div>
  </header>

  <div class="orders-wrap">
    <div class="orders-top">
      <div class="orders-title">Customer Designs ✦</div>
      <button class="refresh-btn" onclick="loadOrders()">↻ refresh</button>
    </div>
    <div class="orders-grid" id="ordersGrid">
      <div class="loading">loading designs...</div>
    </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div class="preview-modal-bg" id="previewBg" onclick="closePreview(event)">
  <div class="preview-modal" id="previewModal">
    <!-- filled by JS -->
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── CONFIG ──────────────────────────────────────────────────
// Set your own admin password here ↓
const ADMIN_PASSWORD = '@Swaggy96';

let SB_URL = localStorage.getItem('sb_url') || '';
let SB_KEY = localStorage.getItem('sb_key') || '';

// Pre-fill if keys already saved
document.getElementById('loginUrl').value = SB_URL;
document.getElementById('loginKey').value = SB_KEY;

// ── LOGIN ──────────────────────────────────────────────────
function doLogin() {
  const url = document.getElementById('loginUrl').value.trim().replace(/\/$/, '');
  const key = document.getElementById('loginKey').value.trim();
  const pass = document.getElementById('loginPass').value;

  if (pass !== ADMIN_PASSWORD) {
    document.getElementById('errMsg').style.display = 'block';
    return;
  }
  if (!url || !key) {
    document.getElementById('errMsg').style.display = 'block';
    return;
  }

  SB_URL = url;
  SB_KEY = key;
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  localStorage.setItem('admin_auth', '1');

  showAdmin();
}

function logout() {
  localStorage.removeItem('admin_auth');
  document.getElementById('adminScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

// Auto-login if already authenticated
if (localStorage.getItem('admin_auth') === '1' && SB_URL && SB_KEY) {
  showAdmin();
}

function showAdmin() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminScreen').style.display = 'block';
  loadOrders();
}

// ── LOAD ORDERS ──────────────────────────────────────────────
async function loadOrders() {
  const grid = document.getElementById('ordersGrid');
  grid.innerHTML = '<div class="loading">loading designs... ✦</div>';

  try {
    const res = await fetch(`${SB_URL}/rest/v1/designs?select=*&order=created_at.desc`, {
      headers: {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`
      }
    });

    if (!res.ok) throw new Error('fetch failed');
    const data = await res.json();

    document.getElementById('orderCount').textContent = data.length + ' design' + (data.length !== 1 ? 's' : '');

    if (!data.length) {
      grid.innerHTML = '<div class="empty-state">no designs yet ✦<br>share your website and orders will appear here!</div>';
      return;
    }

    grid.innerHTML = '';
    data.forEach(order => grid.appendChild(makeCard(order)));

  } catch(e) {
    grid.innerHTML = '<div class="empty-state">could not load designs ✕<br>check your supabase connection</div>';
    console.error(e);
  }
}

// ── MAKE CARD ──────────────────────────────────────────────
function makeCard(order) {
  const card = document.createElement('div');
  card.className = 'order-card';
  card.onclick = () => openPreview(order);

  const stickers = order.stickers || [];
  const date = new Date(order.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  card.innerHTML = `
    <div class="card-preview" style="background:${lighten(order.shirt_color)}">
      ${miniShirt(order.shirt_color, stickers, 'mini')}
    </div>
    <div class="card-info">
      <div class="card-name">${esc(order.name)}</div>
      <div class="card-meta">
        <div class="meta-row">
          <span class="meta-label">from</span>
          <span class="meta-val">${esc(order.customer_name || 'anonymous')}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">contact</span>
          <span class="meta-val">${esc(order.contact || '—')}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">stickers</span>
          <span class="meta-val">${stickers.length} placed</span>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <span class="card-date">${date}</span>
      <span class="card-badge">new ✦</span>
    </div>
  `;
  return card;
}

// ── MINI SHIRT SVG ──────────────────────────────────────────
function miniShirt(color, stickers, size) {
  const sc = color || '#f0ece4';
  const scale = size === 'mini' ? 0.5 : 0.8125;
  const W = size === 'mini' ? 160 : 260;
  const H = size === 'mini' ? 200 : 320;
  const zoneTop = size === 'mini' ? 41 : 67;
  const zoneLeft = size === 'mini' ? 42 : 69;
  const zoneW = size === 'mini' ? 76 : 122;
  const zoneH = size === 'mini' ? 95 : 154;

  const stickerHTML = stickers.map(s => {
    const l = parseFloat(s.left) * scale;
    const t = parseFloat(s.top) * scale;
    const fs = (s.size || 32) * scale;
    const op = (s.opacity || 100) / 100;
    const rot = s.rotation || 0;
    return `<div class="${size === 'mini' ? 'mini' : 'big'}-sticker" style="left:${l}px;top:${t}px;font-size:${fs}px;opacity:${op};transform:rotate(${rot}deg);position:absolute;line-height:1;pointer-events:none;">${s.emoji}</div>`;
  }).join('');

  return `
    <div style="position:relative;width:${W}px;height:${H}px;">
      <svg style="width:100%;height:100%;position:absolute;top:0;left:0;pointer-events:none;" viewBox="0 0 320 400" fill="none">
        <defs>
          <filter id="sf${size}"><feDropShadow dx="0" dy="6" stdDeviation="10" flood-color="#000" flood-opacity="0.10"/></filter>
        </defs>
        <g filter="url(#sf${size})">
          <path d="M98,28 C94,28 74,22 56,42 L8,90 L52,124 L66,105 L66,355 L254,355 L254,105 L268,124 L312,90 L264,42 C246,22 226,28 222,28 C217,52 190,70 160,70 C130,70 103,52 98,28 Z" fill="${sc}" stroke="#ddd9cf" stroke-width="1.2"/>
          <path d="M98,28 C103,52 130,70 160,70 C190,70 217,52 222,28 C208,33 185,40 160,40 C135,40 112,33 98,28 Z" fill="rgba(0,0,0,0.04)"/>
        </g>
      </svg>
      <div style="position:absolute;top:${zoneTop}px;left:${zoneLeft}px;width:${zoneW}px;height:${zoneH}px;overflow:visible;pointer-events:none;">
        ${stickerHTML}
      </div>
    </div>
  `;
}

// ── PREVIEW MODAL ──────────────────────────────────────────
function openPreview(order) {
  const stickers = order.stickers || [];
  const date = new Date(order.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  const chips = stickers.map(s => `<span class="sticker-chip">${s.emoji}</span>`).join('');

  document.getElementById('previewModal').innerHTML = `
    <div class="modal-left">
      ${miniShirt(order.shirt_color, stickers, 'big')}
    </div>
    <div class="modal-right">
      <div class="modal-title">${esc(order.name)}</div>

      <div class="detail-group">
        <div class="detail-label">Customer</div>
        <div class="detail-val">${esc(order.customer_name || 'anonymous')}</div>
      </div>

      <div class="detail-group">
        <div class="detail-label">Contact</div>
        <div class="detail-val">${esc(order.contact || '—')}</div>
      </div>

      <div class="detail-group">
        <div class="detail-label">Shirt Color</div>
        <div class="detail-val">
          <span class="color-preview" style="background:${order.shirt_color || '#f0ece4'}"></span>
          ${order.shirt_color || 'cream'}
        </div>
      </div>

      <div class="detail-group">
        <div class="detail-label">Stickers (${stickers.length})</div>
        <div class="sticker-chips">${chips || '<span style="color:var(--muted);font-size:0.68rem">none</span>'}</div>
      </div>

      <div class="detail-group">
        <div class="detail-label">Submitted</div>
        <div class="detail-val">${date}</div>
      </div>

      <button class="btn btn-ghost modal-close" onclick="closePreviewBtn()">close ✕</button>
    </div>
  `;

  document.getElementById('previewBg').classList.add('open');
}

function closePreview(e) { if (e.target === document.getElementById('previewBg')) closePreviewBtn(); }
function closePreviewBtn() { document.getElementById('previewBg').classList.remove('open'); }

// ── UTILS ──────────────────────────────────────────────────
function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function lighten(hex) {
  // just add slight tint to background
  return hex ? hex + '22' : '#f0ece422';
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2600);
}
</script>
</body>
</html>
